<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Authentication | Recipe Recommendation System</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            background-color: #ffffff;
            font-family: 'Poppins', sans-serif;
            color: #000000;
        }
        .auth-container {
            max-width: 420px;
            margin: 5% auto;
            background: #ffffff;
            border-radius: 16px;
            padding: 35px;
            box-shadow: 0 0 25px rgba(0,0,0,0.1);
        }
        .auth-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .auth-header h2 {
            font-weight: 600;
            color: #000;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #ccc;
        }
        .btn-custom {
            background-color: #d32f2f;
            color: white;
            border-radius: 10px;
            border: none;
        }
        .btn-custom:hover {
            background-color: #b71c1c;
        }
        .toggle-link {
            text-align: center;
            margin-top: 15px;
            color: #000;
            cursor: pointer;
        }
        .toggle-link:hover {
            text-decoration: underline;
        }
        .hidden {
            display: none;
        }
        .message {
            text-align: center;
            font-weight: 500;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="auth-container">
    <!-- Login Form -->
    <div id="login-form">
        <div class="auth-header">
            <h2>Login</h2>
        </div>
        <form id="loginForm">
            <div class="mb-3">
                <label>Username</label>
                <input type="text" name="username" class="form-control"
                       placeholder="Enter your username" required>
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" name="password" class="form-control"
                       placeholder="Enter your password" required>
            </div>
            <button type="submit" class="btn btn-custom w-100">Login</button>
        </form>
        <div class="message" id="loginMessage"></div>
        <div class="toggle-link" onclick="toggleForm()">Donâ€™t have an account? Sign Up</div>
    </div>

    <!-- Signup Form -->
    <div id="signup-form" class="hidden">
        <div class="auth-header">
            <h2>Sign Up</h2>
        </div> 
        <form id="signupForm">
            <div class="mb-3">
                <label>Username</label>
                <input type="text" name="username" class="form-control"
                       placeholder="Enter your username" required>
            </div>
            <div class="mb-3">
                <label>Email</label>
                <input type="email" name="email" class="form-control"
                       placeholder="Enter your email" required>
            </div>
            <div class="mb-3">
                <label>Password</label>
                <input type="password" name="password" class="form-control"
                       placeholder="Create a password" required>
            </div>
            <div class="mb-3">
                <label>Birth Date</label>
                <input type="date" name="birthDate" class="form-control" required>
            </div>
            <div class="mb-3">
                <label>Dietary Preference</label>
                <select name="dietPreference" class="form-select" required>
                    <option value="" disabled selected>Select your preference</option>
                    <option value="Vegetarian">Vegetarian</option>
                    <option value="Vegan">Vegan</option>
                    <option value="Non-Vegetarian">Non-Vegetarian</option>
                    <option value="Keto">Keto</option>
                    <option value="Gluten-Free">Gluten-Free</option>
                    <option value="Pescatarian">Pescatarian</option>
                </select>
            </div>
            <button type="submit" class="btn btn-custom w-100">Sign Up</button>
        </form>
        <div class="message" id="signupMessage"></div>
        <div class="toggle-link" onclick="toggleForm()">Already have an account? Login</div>
    </div>
</div>

<script>
    function toggleForm() {
        document.getElementById("login-form").classList.toggle("hidden");
        document.getElementById("signup-form").classList.toggle("hidden");
    }

    // LOGIN FORM SUBMIT
    document.getElementById("loginForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const username = this.username.value;
        const password = this.password.value;

        const response = await fetch("/api/auth/login", {
            method: "POST",
            credentials: 'same-origin',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        const messageBox = document.getElementById("loginMessage");
        if (response.ok) {
            const user = await response.json();
            messageBox.style.color = "green";
            messageBox.innerText = "Login successful! Welcome, " + user.username;
            // Redirect to home so that authenticated users only see Home
            window.location.href = '/home';
        } else {
            // show server-provided error body (if any) to help debugging
            const errText = await response.text();
            messageBox.style.color = "red";
            messageBox.innerText = errText || "Invalid username or password";
        }
    });

    // SIGNUP FORM SUBMIT
    document.getElementById("signupForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const username = this.username.value;
        const email = this.email.value;
        const password = this.password.value;
        const birthDate = this.birthDate.value;
        const dietPreference = this.dietPreference.value;

        const response = await fetch("/api/auth/register", {
            method: "POST",
            credentials: 'same-origin',
            headers: { "Content-Type": "application/json" },
            // send dietaryPreferences field name to match the User entity
            body: JSON.stringify({ username, email, password, birthDate, dietaryPreferences: dietPreference })
        });

        const messageBox = document.getElementById("signupMessage");
        if (response.ok) {
            const user = await response.json();
            // Attempt to auto-login the newly created user so they can see Home immediately
            const loginResp = await fetch('/api/auth/login', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (loginResp.ok) {
                // On successful login, redirect to home
                window.location.href = '/home';
                return;
            }
            // If auto-login failed, fall back to showing a success message and toggle to login
            const errText = await loginResp.text().catch(() => null);
            messageBox.style.color = "green";
            messageBox.innerText = "Account created successfully!" + (errText ? (" (auto-login error: " + errText + ")") : " Please log in.");
            // Switch back to login form
            document.getElementById("signup-form").classList.add("hidden");
            document.getElementById("login-form").classList.remove("hidden");
        } else {
            const errText = await response.text().catch(() => null);
            messageBox.style.color = "red";
            messageBox.innerText = errText || "Registration failed!";
        }
    });
</script>
</body>
</html>
